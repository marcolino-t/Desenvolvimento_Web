package org.libertas;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.stream.Collectors;

import com.google.gson.Gson;

/**
 * Servlet implementation class PessoaAPI
 */
// @WebServlet("/PessoaAPI/*")
public class PessoaAPI extends HttpServlet {
    private static final long serialVersionUID = 1L;


    public PessoaAPI() {
        super();
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        PessoaDao pdao = new PessoaDao();
        Gson gson = new Gson();
        
        int id = 0;
        try {
            id = Integer.parseInt(request.getPathInfo().substring(1));
        } catch (Exception e) {
            // Log exception (opcional)
        }
        
        String resposta;
        if (id == 0) {
            // Listar todos
            resposta = gson.toJson(pdao.listar());
        } else {
            // Consultar apenas 1
            resposta = gson.toJson(pdao.consultar(id));
        }
        
        response.setHeader("content-type", "application/json");
        response.getWriter().print(resposta);
    }

    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Pega o body da requisição
        String body = request.getReader().lines().collect(Collectors.joining(System.lineSeparator()));
        
        // Converte o body para objeto Java
        Gson gson = new Gson();
        Pessoa p = gson.fromJson(body, Pessoa.class);
        
        // Salva a nova pessoa
        PessoaDao pdao = new PessoaDao();
        boolean sucesso = pdao.inserir(p);
        
        // Envia resposta
        RetornoDao retorno;
        if (sucesso) {
            retorno = new RetornoDao(true, "Pessoa inserida com sucesso!");
        } else {
            retorno = new RetornoDao(false, "Erro ao inserir pessoa.");
        }
        
        response.setContentType("application/json");
        response.getWriter().print(gson.toJson(retorno));
    }

    protected void doPut(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Pega o body da requisição
        String body = request.getReader().lines().collect(Collectors.joining(System.lineSeparator()));
        
        // Converte o body para um objeto Java
        Gson gson = new Gson();
        Pessoa p = gson.fromJson(body, Pessoa.class);
        
        // Pega o id passado por parâmetro
        int id = 0;
        try {
            id = Integer.parseInt(request.getPathInfo().substring(1));
        } catch (Exception e) {
           
        }
        p.setIdpessoa(id);
        
        // Altera a pessoa
        PessoaDao pdao = new PessoaDao();
        boolean sucesso = pdao.alterar(p);
        
        // Envia resposta
        RetornoDao retorno;
        if (sucesso) {
            retorno = new RetornoDao(true, "Pessoa alterada com sucesso!");
        } else {
            retorno = new RetornoDao(false, "Erro ao alterar pessoa.");
        }
        
        response.setContentType("application/json");
        response.getWriter().print(gson.toJson(retorno));
    }

    protected void doDelete(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Pega o id passado por parâmetro
        int id = 0;
        try {
            id = Integer.parseInt(request.getPathInfo().substring(1));
        } catch (Exception e) {
            
        }
        
        // Exclui a pessoa
        PessoaDao pdao = new PessoaDao();
        Pessoa p = new Pessoa();
        p.setIdpessoa(id);
        boolean sucesso = pdao.excluir(p);
        
        // Envia resposta
        RetornoDao retorno;
        if (sucesso) {
            retorno = new RetornoDao(true, "Pessoa excluída com sucesso!");
        } else {
            retorno = new RetornoDao(false, "Erro ao excluir pessoa.");
        }
        
        response.setContentType("application/json");
        Gson gson= new Gson();
        response.getWriter().print(gson.toJson(retorno));  //erro desconhecido
    }
}